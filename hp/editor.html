<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>ULTIMATE GAME EDITOR</title>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
    <style>
        :root { --c1: #00ff88; --c2: #0088ff; --bg: #050505; --panel: #111; }
        body { 
            background: var(--bg); color: #eee; font-family: 'Rajdhani', sans-serif;
            display: flex; flex-direction: column; align-items: center; min-height: 100vh; margin:0; padding: 20px;
            background-image: linear-gradient(rgba(0, 255, 136, 0.05) 1px, transparent 1px),
            linear-gradient(90deg, rgba(0, 255, 136, 0.05) 1px, transparent 1px);
            background-size: 30px 30px;
        }
        h1 { font-size: 42px; text-transform: uppercase; letter-spacing: 3px; margin-bottom: 20px; text-shadow: 0 0 15px var(--c1); }
        
        .container {
            display: flex; gap: 20px; width: 1200px; max-width: 95%;
        }
        
        .col { flex: 1; background: var(--panel); border: 1px solid #333; padding: 25px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        
        h2 { border-bottom: 2px solid #333; padding-bottom: 10px; margin-top: 0; color: var(--c1); }
        
        label { display: block; margin-top: 15px; font-size: 18px; color: #aaa; }
        input, textarea, select {
            width: 100%; background: #000; border: 1px solid #444; color: white; padding: 12px;
            font-family: inherit; font-size: 16px; margin-top: 5px; box-sizing: border-box;
        }
        input:focus, textarea:focus, select:focus { border-color: var(--c1); outline: none; }

        .mode-switch { display: flex; gap: 10px; margin-top: 10px; }
        .mode-btn { flex: 1; padding: 10px; background: #222; border: 1px solid #444; color: #888; cursor: pointer; text-align: center; font-weight: bold; }
        .mode-btn.active { background: var(--c2); color: white; border-color: var(--c2); box-shadow: 0 0 15px rgba(0,136,255,0.4); }

        #google-settings, #minimax-settings { display: none; margin-top: 20px; padding: 15px; border: 1px dashed #444; }
        .active-settings { display: block !important; }

        /* Sliders */
        .slider-row { display: flex; gap: 15px; margin-top: 10px; }
        input[type="range"] { width: 100%; accent-color: var(--c1); }

        .big-btn {
            width: 100%; background: var(--c1); color: black; font-weight: 900; font-size: 24px;
            padding: 20px; border: none; cursor: pointer; margin-top: 20px; text-transform: uppercase;
            clip-path: polygon(0 0, 100% 0, 100% 85%, 95% 100%, 0 100%); transition: 0.2s;
        }
        .big-btn:hover { filter: brightness(1.2); transform: translateY(-2px); }
        .big-btn:disabled { background: #444; cursor: not-allowed; }

        .progress-bar { width: 100%; height: 6px; background: #222; margin-top: 15px; display: none; }
        .fill { width: 0%; height: 100%; background: var(--c2); transition: width 0.3s; }

        #output { margin-top: 20px; display: none; }
        #status { color: #ff5555; margin-top: 10px; font-weight: bold; }
    </style>
</head>
<body>

<h1>Game Engine Configurator</h1>

<div class="container">
    <div class="col">
        <h2>1. GAME CONTENT</h2>
        
        <label>SKY TEXT (Заголовок в небе)</label>
        <input type="text" id="skyMsg" value="HAPPY BIRTHDAY!">

        <label>BALLOONS (Фразы в шариках)</label>
        <textarea id="balloons" rows="8">You are the best!
Level Up!
Good Luck!
Super Star!</textarea>
        <small style="color:#666">Одна фраза на строку</small>
    </div>

    <div class="col">
        <h2>2. AUDIO ENGINE</h2>
        
        <label>SELECT VOICE PROVIDER:</label>
        <div class="mode-switch">
            <div class="mode-btn active" onclick="setMode('google', this)">GOOGLE (FREE)</div>
            <div class="mode-btn" onclick="setMode('minimax', this)">MINIMAX (API)</div>
        </div>

        <div id="google-settings" class="active-settings">
            <label>LANGUAGE:</label>
            <select id="gLang">
                <option value="ru">Russian (Русский)</option>
                <option value="en">English (США)</option>
                <option value="zh-CN">Chinese (Китайский)</option>
                <option value="ja">Japanese (Японский)</option>
                <option value="de">German (Немецкий)</option>
            </select>

            <div class="slider-row">
                <div style="flex:1">
                    <label>PITCH (Тон): <span id="gPitchVal">1.0</span></label>
                    <input type="range" id="gPitch" min="0.5" max="2" step="0.1" value="1.0" oninput="document.getElementById('gPitchVal').innerText=this.value">
                </div>
                <div style="flex:1">
                    <label>RATE (Скорость): <span id="gRateVal">1.0</span></label>
                    <input type="range" id="gRate" min="0.5" max="2" step="0.1" value="1.0" oninput="document.getElementById('gRateVal').innerText=this.value">
                </div>
            </div>
            <button onclick="testGoogle()" style="width:100%; margin-top:10px; padding:10px; background:#333; color:white; border:none; cursor:pointer;">▶ TEST GOOGLE</button>
        </div>

        <div id="minimax-settings">
            <label>API KEY:</label>
            <input type="password" id="mmKey" placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...">
            
            <label>GROUP ID:</label>
            <input type="text" id="mmGroup" placeholder="1234567890">

            <label>VOICE ID:</label>
            <input type="text" id="mmVoice" value="male-qn-qingse" placeholder="voice_id">
            
            <button onclick="testMinimax()" style="width:100%; margin-top:10px; padding:10px; background:#333; color:white; border:none; cursor:pointer;">▶ TEST MINIMAX (Спишет токены)</button>
            <p style="font-size:12px; color:#666">Minimax озвучка будет "запечена" в файл игры.</p>
        </div>

        <button id="pubBtn" class="big-btn" onclick="publish()">BUILD & PUBLISH</button>
        
        <div class="progress-bar" id="pBar"><div class="fill" id="pFill"></div></div>
        <div id="status"></div>
        
        <div id="output">
            <label>GAME LINK:</label>
            <textarea id="finalCode" rows="4" readonly></textarea>
        </div>
    </div>
</div>

<script>
    let currentMode = 'google';
    let audioMap = {}; // Для запекания Minimax

    function setMode(mode, btn) {
        currentMode = mode;
        document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById('google-settings').style.display = mode === 'google' ? 'block' : 'none';
        document.getElementById('minimax-settings').style.display = mode === 'minimax' ? 'block' : 'none';
    }

    // --- GOOGLE LOGIC ---
    function testGoogle() {
        const lang = document.getElementById('gLang').value;
        const text = "Audio test. One two three.";
        const url = `https://translate.google.com/translate_tts?ie=UTF-8&client=tw-ob&tl=${lang}&q=${encodeURIComponent(text)}`;
        new Audio(url).play();
    }

    // --- MINIMAX LOGIC ---
    async function callMinimax(text) {
        const apiKey = document.getElementById('mmKey').value;
        const groupId = document.getElementById('mmGroup').value;
        const voiceId = document.getElementById('mmVoice').value;
        
        // Стандартный эндпоинт Minimax T2A (может отличаться в зависимости от версии API)
        const url = `https://api.minimax.chat/v1/t2a_v2?GroupId=${groupId}`;
        
        const res = await fetch(url, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${apiKey}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                model: "speech-01-turbo",
                text: text,
                voice_setting: {
                    voice_id: voiceId,
                    speed: 1.0,
                    vol: 1.0,
                    pitch: 0
                },
                audio_setting: {
                    sample_rate: 32000,
                    bitrate: 128000,
                    format: "mp3",
                    channel: 1
                }
            })
        });

        if (!res.ok) {
            const err = await res.text();
            throw new Error("Minimax Error: " + err);
        }

        const data = await res.json();
        if (data.base_resp && data.base_resp.status_code !== 0) {
            throw new Error("Minimax API Error: " + data.base_resp.status_msg);
        }
        
        // Minimax иногда возвращает URL, иногда hex, иногда base64 в data.data.audio
        // Предполагаем, что он возвращает hex string, которую надо конвертировать в mp3 url или base64
        // Для упрощения, если это hex, конвертируем в blob. 
        // ВАЖНО: Структура ответа Minimax меняется. Проверьте документацию.
        // Обычно data.data.audio содержит hex string.
        
        return data.data.audio; // Возвращаем hex string
    }

    function hexToBase64(hexstring) {
        return btoa(hexstring.match(/\w{2}/g).map(function(a) {
            return String.fromCharCode(parseInt(a, 16));
        }).join(""));
    }

    async function testMinimax() {
        try {
            const hex = await callMinimax("Test connection.");
            const base64 = hexToBase64(hex);
            const audio = new Audio("data:audio/mp3;base64," + base64);
            audio.play();
        } catch(e) {
            alert(e.message);
        }
    }

    // --- PUBLISH ---
    async function publish() {
        const btn = document.getElementById('pubBtn');
        const status = document.getElementById('status');
        btn.disabled = true;
        status.innerText = "STARTING BUILD PROCESS...";
        
        const skyText = document.getElementById('skyMsg').value;
        const phrases = document.getElementById('balloons').value.split('\n').filter(l => l.trim());
        
        let finalData = {
            skyText: skyText,
            balloons: phrases,
            mode: currentMode,
            googleSettings: {
                lang: document.getElementById('gLang').value,
                pitch: parseFloat(document.getElementById('gPitch').value),
                rate: parseFloat(document.getElementById('gRate').value)
            },
            audioMap: {}
        };

        try {
            if (currentMode === 'minimax') {
                document.getElementById('pBar').style.display = 'block';
                // Запекаем аудио
                for(let i=0; i<phrases.length; i++) {
                    status.innerText = `BAKING AUDIO (${i+1}/${phrases.length}): "${phrases[i]}"`;
                    document.getElementById('pFill').style.width = `${((i)/phrases.length)*100}%`;
                    
                    const hex = await callMinimax(phrases[i]);
                    const base64 = hexToBase64(hex);
                    finalData.audioMap[phrases[i]] = "data:audio/mp3;base64," + base64;
                }
                document.getElementById('pFill').style.width = `100%`;
            }

            status.innerText = "UPLOADING TO SERVER...";
            const gameId = 'game-' + Date.now().toString(36);

            const res = await fetch('https://publisher-server-ihqm.onrender.com/publish', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-Publish-Key': 'super-secret-123' },
                body: JSON.stringify({ id: gameId, folder: 'data', data: finalData })
            });

            if(!res.ok) throw new Error("Upload Failed");

            status.innerText = "SUCCESS! LINK GENERATED.";
            const url = `https://kgbgamelab.github.io/67/hp/index.html?id=${gameId}`;
            const iframe = `<iframe src="${url}" width="100%" height="100%" style="border:none; position:fixed; top:0; left:0;" allow="autoplay"></iframe>`;
            
            document.getElementById('output').style.display = 'block';
            document.getElementById('finalCode').value = iframe;

        } catch(e) {
            status.innerText = "ERROR: " + e.message;
        } finally {
            btn.disabled = false;
        }
    }
</script>
</body>
</html>
