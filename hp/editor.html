<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Minecraft Party Editor (Server Mode)</title>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <style>
        :root { --main: #ff55ff; --bg: #111; }
        body { 
            background: var(--bg); color: white; font-family: 'VT323', monospace;
            display: flex; flex-direction: column; align-items: center; min-height: 100vh;
            background-image: linear-gradient(rgba(255, 85, 255, 0.1) 1px, transparent 1px),
            linear-gradient(90deg, rgba(255, 85, 255, 0.1) 1px, transparent 1px);
            background-size: 40px 40px;
        }
        h1 { font-size: 60px; color: var(--main); text-shadow: 4px 4px #000; margin: 20px 0; }
        .editor-box {
            background: rgba(0,0,0,0.85); border: 4px solid var(--main); padding: 30px;
            width: 600px; max-width: 90%; box-shadow: 0 0 40px var(--main);
        }
        .group { margin-bottom: 20px; }
        label { display: block; font-size: 26px; color: #ffff55; margin-bottom: 5px; }
        input, textarea, select { 
            width: 100%; box-sizing: border-box; background: #333; border: 2px solid #555; 
            color: white; font-size: 22px; padding: 10px; font-family: inherit;
        }
        input[type="checkbox"] { width: 30px; height: 30px; vertical-align: middle; }
        
        .btn {
            background: var(--main); color: white; border: none; font-size: 30px; 
            padding: 15px; width: 100%; cursor: pointer; border-bottom: 6px solid #aa00aa; margin-top: 10px;
        }
        .btn:active { border-bottom: 0; transform: translateY(6px); }
        .btn:disabled { background: #555; cursor: not-allowed; border-bottom: 6px solid #333; }

        #output { 
            margin-top: 20px; background: #000; color: #0f0; border: 1px dashed #0f0; 
            padding: 10px; font-size: 16px; word-break: break-all; display: none;
        }
        #statusMsg { text-align: center; font-size: 20px; margin-top: 10px; color: #ffff55; min-height: 30px;}
    </style>
</head>
<body>

<h1>PARTY SERVER EDITOR</h1>

<div class="editor-box">
    <div class="group">
        <label>–¢–µ–∫—Å—Ç –≤ –Ω–µ–±–µ:</label>
        <input type="text" id="skyMsg" value="–° –î–ù–ï–ú –†–û–ñ–î–ï–ù–ò–Ø!" placeholder="–¢–µ–∫—Å—Ç –≤ –Ω–µ–±–µ">
    </div>

    <div class="group">
        <label>–§—Ä–∞–∑—ã –≤ —à–∞—Ä–∏–∫–∞—Ö (–ø–æ –æ–¥–Ω–æ–π –Ω–∞ —Å—Ç—Ä–æ–∫—É):</label>
        <textarea id="balloons" rows="5">–¢—ã —Å—É–ø–µ—Ä!
–ñ–µ–ª–∞—é —Å—á–∞—Å—Ç—å—è!
Level Up!
–ì–µ–π–º–µ—Ä ‚Ññ1</textarea>
    </div>

    <div class="group" style="display: flex; align-items: center; gap: 10px;">
        <input type="checkbox" id="ttsEnabled" checked>
        <label for="ttsEnabled" style="margin:0; cursor:pointer;">–í–∫–ª—é—á–∏—Ç—å —á—Ç–µ–Ω–∏–µ –≤—Å–ª—É—Ö</label>
    </div>

    <div class="group">
        <label>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≥–æ–ª–æ—Å–∞:</label>
        <select id="voiceSelect"><option>–ó–∞–≥—Ä—É–∑–∫–∞ –≥–æ–ª–æ—Å–æ–≤...</option></select>
        <div style="display: flex; gap: 10px; margin-top: 10px;">
            <div style="flex:1"><label>–°–∫–æ—Ä–æ—Å—Ç—å:</label><input type="range" id="rate" min="0.5" max="2" step="0.1" value="1"></div>
            <div style="flex:1"><label>–¢–æ–Ω:</label><input type="range" id="pitch" min="0.5" max="2" step="0.1" value="1"></div>
        </div>
        <button onclick="testVoice()" style="margin-top:10px; background:#444; color:white; border:none; padding:5px; cursor:pointer; width:100%;">üîä –¢–µ—Å—Ç –≥–æ–ª–æ—Å–∞</button>
    </div>

    <button id="saveBtn" class="btn" onclick="saveAndPublish()">–°–û–•–†–ê–ù–ò–¢–¨ –ò –ü–û–õ–£–ß–ò–¢–¨ –°–°–´–õ–ö–£</button>
    <div id="statusMsg"></div>

    <div id="output">
        <p>–°—Å—ã–ª–∫–∞ –≥–æ—Ç–æ–≤–∞! (–î–∞–Ω–Ω—ã–µ –ø–æ—è–≤—è—Ç—Å—è —á–µ—Ä–µ–∑ 1-2 –º–∏–Ω—É—Ç—ã –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è GitHub):</p>
        <textarea id="codeResult" rows="6" readonly style="font-size: 14px; color: #0f0; background: #000;"></textarea>
    </div>
</div>

<script>
    // --- –ì–û–õ–û–°–ê ---
    let voices = [];
    function loadVoices() {
        voices = window.speechSynthesis.getVoices();
        const select = document.getElementById('voiceSelect');
        select.innerHTML = '';
        voices.sort((a,b) => (a.lang.includes('ru') && !b.lang.includes('ru')) ? -1 : 1);
        voices.forEach(v => {
            const opt = document.createElement('option');
            opt.value = v.voiceURI;
            opt.text = `${v.name} (${v.lang})`;
            select.appendChild(opt);
        });
    }
    window.speechSynthesis.onvoiceschanged = loadVoices;
    setTimeout(loadVoices, 500);

    function testVoice() {
        if (!document.getElementById('ttsEnabled').checked) return alert("–í–∫–ª—é—á–∏—Ç–µ –≥–∞–ª–æ—á–∫—É '–ß—Ç–µ–Ω–∏–µ –≤—Å–ª—É—Ö'!");
        const msg = new SpeechSynthesisUtterance("–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–≤—è–∑–∏. –û–¥–∏–Ω –¥–≤–∞ —Ç—Ä–∏.");
        msg.voice = voices.find(v => v.voiceURI === document.getElementById('voiceSelect').value);
        msg.rate = document.getElementById('rate').value;
        msg.pitch = document.getElementById('pitch').value;
        window.speechSynthesis.cancel();
        window.speechSynthesis.speak(msg);
    }

    // --- –ü–£–ë–õ–ò–ö–ê–¶–ò–Ø ---
    async function saveAndPublish() {
        const btn = document.getElementById('saveBtn');
        const status = document.getElementById('statusMsg');
        
        btn.disabled = true;
        status.innerText = "–û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä...";

        // 1. –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ
        const gameId = 'hp-' + Date.now(); // –£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID
        const gameConfig = {
            skyText: document.getElementById('skyMsg').value,
            balloons: document.getElementById('balloons').value.split('\n').filter(line => line.trim() !== ''),
            tts: {
                enabled: document.getElementById('ttsEnabled').checked,
                voiceURI: document.getElementById('voiceSelect').value,
                pitch: document.getElementById('rate').value,
                rate: document.getElementById('pitch').value
            }
        };

        // 2. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ Render
        try {
            const response = await fetch('https://publisher-server-ihqm.onrender.com/publish', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Publish-Key': 'super-secret-123'
                },
                body: JSON.stringify({
                    id: gameId,
                    folder: 'data',
                    data: gameConfig
                })
            });

            if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ' + response.status);

            // 3. –£—Å–ø–µ—Ö
            status.innerText = "–£—Å–ø–µ—à–Ω–æ! GitHub –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è...";
            
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º iframe
            const gameUrl = `https://kgbgamelab.github.io/67/hp/hp.html?id=${gameId}`;
            const iframeCode = `<iframe src="${gameUrl}" width="800" height="600" style="border:none; border-radius:10px; box-shadow:0 0 20px rgba(0,0,0,0.5);" allow="autoplay"></iframe>`;
            
            document.getElementById('output').style.display = 'block';
            document.getElementById('codeResult').value = iframeCode;

        } catch (error) {
            console.error(error);
            status.innerText = "–û—à–∏–±–∫–∞: " + error.message;
        } finally {
            btn.disabled = false;
        }
    }
</script>

</body>
</html>
