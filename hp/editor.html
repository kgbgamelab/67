<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>ULTIMATE PARTY EDITOR (FIXED)</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@800&family=VT323&display=swap" rel="stylesheet">
    <style>
        :root { --main: #ff00ff; --sec: #00ffff; --bg: #120520; }
        body { 
            background: var(--bg); color: white; font-family: 'Montserrat', sans-serif;
            display: flex; flex-direction: column; align-items: center; min-height: 100vh; margin:0; padding: 20px;
            background-image: linear-gradient(rgba(255, 0, 255, 0.1) 1px, transparent 1px),
            linear-gradient(90deg, rgba(0, 255, 255, 0.1) 1px, transparent 1px);
            background-size: 40px 40px;
        }
        h1 { 
            font-family: 'VT323', monospace; font-size: 60px; margin-bottom: 20px; 
            text-transform: uppercase; letter-spacing: 4px;
            text-shadow: 3px 3px 0 var(--sec), -3px -3px 0 var(--main);
        }
        .container {
            display: flex; gap: 30px; width: 1100px; max-width: 95%;
            background: rgba(0,0,0,0.7); backdrop-filter: blur(10px); padding: 30px;
            border: 2px solid var(--main); border-radius: 20px;
            box-shadow: 0 0 50px rgba(255, 0, 255, 0.2);
        }
        .col { flex: 1; display: flex; flex-direction: column; gap: 20px; }
        h2 { font-family: 'VT323'; color: var(--sec); border-bottom: 2px solid #444; margin: 0; padding-bottom: 10px; font-size: 30px; }
        label { display: block; font-size: 14px; color: #aaa; margin-bottom: 5px; font-weight: bold; }
        input, textarea, select {
            width: 100%; background: #0a0510; border: 2px solid #442255; color: white; padding: 15px;
            font-family: 'VT323'; font-size: 22px; border-radius: 8px; box-sizing: border-box;
        }
        input:focus, textarea:focus, select:focus { border-color: var(--sec); outline: none; }
        
        .tabs { display: flex; gap: 10px; margin-bottom: 15px; }
        .tab { 
            flex: 1; padding: 10px; background: #221133; border: 1px solid #442255; cursor: pointer; 
            text-align: center; font-weight: bold; border-radius: 5px; color: #888;
        }
        .tab.active { background: var(--main); color: white; border-color: white; box-shadow: 0 0 15px var(--main); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .emo-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .emo-btn {
            background: #221133; border: 1px solid var(--sec); color: var(--sec); padding: 10px;
            cursor: pointer; font-family: 'VT323'; font-size: 20px; border-radius: 5px; transition: 0.2s;
        }
        .emo-btn.active { background: var(--sec); color: black; font-weight: bold; }

        .test-btn { background: #333; color: white; border: none; padding: 15px; width: 100%; cursor: pointer; font-weight: bold; border-radius: 8px; margin-top: 10px; }
        .pub-btn {
            background: linear-gradient(45deg, var(--main), var(--sec)); color: black; border: none;
            padding: 20px; font-size: 24px; font-weight: 900; width: 100%; cursor: pointer;
            border-radius: 10px; margin-top: 20px; text-transform: uppercase;
        }
        #output { margin-top: 20px; display: none; background: black; padding: 15px; border-radius: 10px; border: 1px dashed var(--sec); }
        #status { text-align: center; color: var(--sec); margin-top: 10px; font-weight: bold; }
    </style>
</head>
<body>

<h1>üéâ GIFT EDITOR PRO üéâ</h1>

<div class="container">
    <div class="col">
        <h2>1. –ù–ê–ü–û–õ–ù–ï–ù–ò–ï</h2>
        <div><label>–¢–µ–∫—Å—Ç –≤ –Ω–µ–±–µ:</label><input type="text" id="skyMsg" value="–° –î–ù–ï–ú –†–û–ñ–î–ï–ù–ò–Ø!"></div>
        <div style="flex:1; display:flex; flex-direction:column;">
            <label>–§—Ä–∞–∑—ã (–ø–æ –æ–¥–Ω–æ–π –≤ —Å—Ç—Ä–æ–∫–µ):</label>
            <textarea id="balloons" style="flex:1; resize:none;">–¢—ã –ª—É—á—à–∏–π!
–£–¥–∞—á–∏ –≤–æ –≤—Å–µ–º!
–ë—É–¥—å —Å—á–∞—Å—Ç–ª–∏–≤!
Level Up!</textarea>
        </div>
    </div>

    <div class="col">
        <h2>2. –ù–ê–°–¢–†–û–ô–ö–ò –ì–û–õ–û–°–ê</h2>
        <div class="tabs">
            <div class="tab active" onclick="switchTab('google', this)">GOOGLE (–ë–ï–°–ü–õ–ê–¢–ù–û)</div>
            <div class="tab" onclick="switchTab('minimax', this)">MINIMAX (API)</div>
        </div>

        <div id="tab-google" class="tab-content active">
            <label>–Ø–∑—ã–∫:</label>
            <select id="gLang">
                <option value="ru">üá∑üá∫ –†—É—Å—Å–∫–∏–π</option>
                <option value="en">üá∫üá∏ –ê–Ω–≥–ª–∏–π—Å–∫–∏–π</option>
                <option value="de">üá©üá™ –ù–µ–º–µ—Ü–∫–∏–π</option>
                <option value="fr">üá´üá∑ –§—Ä–∞–Ω—Ü—É–∑—Å–∫–∏–π</option>
                <option value="es">üá™üá∏ –ò—Å–ø–∞–Ω—Å–∫–∏–π</option>
                <option value="it">üáÆüáπ –ò—Ç–∞–ª—å—è–Ω—Å–∫–∏–π</option>
                <option value="zh-CN">üá®üá≥ –ö–∏—Ç–∞–π—Å–∫–∏–π</option>
                <option value="ja">üáØüáµ –Ø–ø–æ–Ω—Å–∫–∏–π</option>
            </select>

            <label style="margin-top:15px">–ò–Ω—Ç–æ–Ω–∞—Ü–∏—è:</label>
            <div class="emo-grid">
                <div class="emo-btn active" onclick="setPreset(1, 1, this)">üòê –û–±—ã—á–Ω—ã–π</div>
                <div class="emo-btn" onclick="setPreset(1.2, 1.1, this)">üòÑ –†–∞–¥–æ—Å—Ç—å</div>
                <div class="emo-btn" onclick="setPreset(1.4, 1.3, this)">ü§™ –ú—É–ª—å—Ç–∏–∫</div>
                <div class="emo-btn" onclick="setPreset(0.8, 0.9, this)">üòé –≠–ø–∏—á–Ω—ã–π</div>
            </div>
            
            <input type="hidden" id="gPitch" value="1">
            <input type="hidden" id="gRate" value="1">
            <button class="test-btn" onclick="testGoogleChain()">üîä –ü–†–û–°–õ–£–®–ê–¢–¨ (–¢–ï–°–¢)</button>
        </div>

        <div id="tab-minimax" class="tab-content">
            <label>API Key:</label><input type="password" id="mmKey" placeholder="–ö–ª—é—á Minimax...">
            <label>Group ID:</label><input type="text" id="mmGroup">
            <label>Voice ID:</label><input type="text" id="mmVoice" value="male-qn-qingse">
            <button class="test-btn" onclick="testMinimax()">üîä –¢–ï–°–¢ (API)</button>
        </div>

        <button id="pubBtn" class="pub-btn" onclick="publish()">üéÅ –°–û–ó–î–ê–¢–¨ –ò–ì–†–£</button>
        <div id="status"></div>
    </div>
</div>

<div id="output" style="width: 1100px; max-width: 95%;">
    <label style="color:var(--sec)">–°–°–´–õ–ö–ê:</label>
    <textarea id="finalCode" rows="4" readonly></textarea>
</div>

<script>
    let currentMode = 'google';
    
    // --- –ê–ù–õ–û–ö –ó–í–£–ö–ê ---
    function unlockAudio() {
        const Ctx = window.AudioContext || window.webkitAudioContext;
        if(!Ctx) return;
        const ctx = new Ctx();
        if(ctx.state === 'suspended') ctx.resume();
        const buf = ctx.createBuffer(1,1,22050);
        const src = ctx.createBufferSource();
        src.buffer = buf; src.connect(ctx.destination); src.start(0);
    }
    document.body.addEventListener('click', unlockAudio, {once:true});

    function switchTab(mode, btn) {
        currentMode = mode;
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        btn.classList.add('active');
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.getElementById('tab-'+mode).classList.add('active');
    }

    function setPreset(pitch, rate, btn) {
        document.getElementById('gPitch').value = pitch;
        document.getElementById('gRate').value = rate;
        document.querySelectorAll('.emo-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        testGoogleChain();
    }

    // --- –£–ú–ù–´–ô –¢–ï–°–¢ –ó–í–£–ö–ê (–° –ü–ï–†–ï–ë–û–†–û–ú –°–ï–†–í–ï–†–û–í) ---
    function testGoogleChain() {
        const lang = document.getElementById('gLang').value;
        const text = "–û–¥–∏–Ω –¥–≤–∞ —Ç—Ä–∏. –¢–µ—Å—Ç.";
        const status = document.getElementById('status');
        
        status.innerText = "‚è≥ –ü–æ–¥–±–æ—Ä —Å–µ—Ä–≤–µ—Ä–∞...";
        status.style.color = "#aaa";

        // –°–ø–∏—Å–æ–∫ —Å–µ—Ä–≤–µ—Ä–æ–≤ (–æ—Ç –ª—É—á—à–µ–≥–æ –∫ —Ö—É–¥—à–µ–º—É)
        const urls = [
            `https://translate.googleapis.com/translate_tts?client=gtx&ie=UTF-8&tl=${lang}&q=${encodeURIComponent(text)}`,
            `https://translate.google.com/translate_tts?ie=UTF-8&client=dict-chrome-ex&tl=${lang}&q=${encodeURIComponent(text)}`, 
            `https://translate.google.com/translate_tts?ie=UTF-8&client=tw-ob&tl=${lang}&q=${encodeURIComponent(text)}`
        ];

        playChain(urls, 0);
    }

    function playChain(urls, index) {
        const status = document.getElementById('status');
        if (index >= urls.length) {
            // –ï—Å–ª–∏ –≤—Å–µ —Å—Å—ã–ª–∫–∏ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–∏ -> –°–∏—Å—Ç–µ–º–Ω—ã–π –≥–æ–ª–æ—Å
            fallbackTest();
            return;
        }

        const audio = new Audio(urls[index]);
        audio.playbackRate = parseFloat(document.getElementById('gRate').value);
        
        const p = audio.play();
        if (p !== undefined) {
            p.then(() => {
                status.innerText = "‚úÖ Google –≥–æ–ª–æ—Å (–°–µ—Ä–≤–µ—Ä " + (index+1) + ")";
                status.style.color = "#00ff00";
            }).catch(e => {
                console.warn("Server " + (index+1) + " fail, trying next...");
                playChain(urls, index + 1);
            });
        }
    }

    function fallbackTest() {
        const status = document.getElementById('status');
        if (!window.speechSynthesis) return;
        window.speechSynthesis.cancel();
        const msg = new SpeechSynthesisUtterance("–û–¥–∏–Ω –¥–≤–∞ —Ç—Ä–∏. –¢–µ—Å—Ç.");
        const lang = document.getElementById('gLang').value;
        msg.rate = parseFloat(document.getElementById('gRate').value);
        msg.pitch = parseFloat(document.getElementById('gPitch').value);
        
        const v = window.speechSynthesis.getVoices().find(x => x.lang.includes(lang));
        if(v) msg.voice = v;

        window.speechSynthesis.speak(msg);
        status.innerText = "‚ö†Ô∏è –°–∏—Å—Ç–µ–º–Ω—ã–π –≥–æ–ª–æ—Å (Google –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω)";
        status.style.color = "orange";
    }

    // --- –ü–£–ë–õ–ò–ö–ê–¶–ò–Ø ---
    async function publish() {
        const btn = document.getElementById('pubBtn');
        const status = document.getElementById('status');
        btn.disabled = true;
        status.innerText = "–°–ë–û–†–ö–ê...";

        const data = {
            skyText: document.getElementById('skyMsg').value,
            balloons: document.getElementById('balloons').value.split('\n').filter(x => x.trim()),
            mode: currentMode,
            googleSettings: {
                lang: document.getElementById('gLang').value,
                pitch: parseFloat(document.getElementById('gPitch').value),
                rate: parseFloat(document.getElementById('gRate').value)
            },
            audioMap: {}
        };

        try {
            status.innerText = "–ó–ê–ì–†–£–ó–ö–ê...";
            const id = 'hp-' + Date.now().toString(36);
            
            const res = await fetch('https://publisher-server-ihqm.onrender.com/publish', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-Publish-Key': 'super-secret-123' },
                body: JSON.stringify({ id: id, folder: 'data', data: data })
            });

            if(!res.ok) throw new Error("–°–µ—Ä–≤–µ—Ä –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç");

            status.innerText = "–ì–û–¢–û–í–û!";
            const url = `https://kgbgamelab.github.io/67/hp/index.html?id=${id}`;
            const iframe = `<iframe src="${url}" width="100%" height="100%" style="border:none; position:fixed; top:0; left:0;" allow="autoplay"></iframe>`;
            
            document.getElementById('output').style.display = 'block';
            document.getElementById('finalCode').value = iframe;

        } catch(e) {
            status.innerText = "–û–®–ò–ë–ö–ê: " + e.message;
            status.style.color = "red";
        } finally {
            btn.disabled = false;
        }
    }
</script>
</body>
</html>
