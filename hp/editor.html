<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Minecraft Party Editor (Emotions)</title>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <style>
        :root { --main: #ff55ff; --bg: #111; --sec: #00ffaa; }
        body { 
            background: var(--bg); color: white; font-family: 'VT323', monospace;
            display: flex; flex-direction: column; align-items: center; min-height: 100vh;
            background-image: linear-gradient(rgba(255, 85, 255, 0.1) 1px, transparent 1px),
            linear-gradient(90deg, rgba(255, 85, 255, 0.1) 1px, transparent 1px);
            background-size: 40px 40px;
        }
        h1 { font-size: 60px; color: var(--main); text-shadow: 4px 4px #000; margin: 20px 0; }
        .editor-box {
            background: rgba(0,0,0,0.9); border: 4px solid var(--main); padding: 30px;
            width: 600px; max-width: 90%; box-shadow: 0 0 40px var(--main);
        }
        .group { margin-bottom: 25px; border-bottom: 1px solid #333; padding-bottom: 20px; }
        label { display: block; font-size: 26px; color: #ffff55; margin-bottom: 5px; }
        input, textarea, select { 
            width: 100%; box-sizing: border-box; background: #222; border: 2px solid #555; 
            color: white; font-size: 22px; padding: 10px; font-family: inherit;
        }
        input:focus, textarea:focus { border-color: var(--sec); outline: none; }
        
        /* Checkbox style */
        .check-group { display: flex; align-items: center; gap: 15px; cursor: pointer; }
        input[type="checkbox"] { width: 25px; height: 25px; accent-color: var(--main); cursor: pointer; }

        /* Emotion Buttons */
        .emotion-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .emo-btn {
            background: #333; color: white; border: 2px solid #555; padding: 10px;
            cursor: pointer; font-family: inherit; font-size: 18px; transition: 0.2s;
        }
        .emo-btn:hover { background: #444; border-color: white; }
        .emo-btn.active { background: var(--sec); color: black; border-color: var(--sec); font-weight: bold; }

        .btn {
            background: var(--main); color: white; border: none; font-size: 30px; 
            padding: 15px; width: 100%; cursor: pointer; border-bottom: 6px solid #aa00aa; margin-top: 10px;
        }
        .btn:active { border-bottom: 0; transform: translateY(6px); }
        .btn:disabled { background: #555; cursor: not-allowed; border-bottom: 6px solid #333; }

        #output { 
            margin-top: 20px; background: #000; color: #0f0; border: 1px dashed #0f0; 
            padding: 10px; font-size: 16px; word-break: break-all; display: none;
        }
        #statusMsg { text-align: center; font-size: 20px; margin-top: 10px; color: #ffff55; min-height: 30px;}
    </style>
</head>
<body>

<h1>PARTY EDITOR <span style="color:var(--sec)">V2</span></h1>

<div class="editor-box">
    <div class="group">
        <label>–¢–µ–∫—Å—Ç –≤ –Ω–µ–±–µ (–ë–∞–Ω–Ω–µ—Ä):</label>
        <input type="text" id="skyMsg" value="–° –î–ù–ï–ú –†–û–ñ–î–ï–ù–ò–Ø!" placeholder="–¢–µ–∫—Å—Ç –≤ –Ω–µ–±–µ">
    </div>

    <div class="group">
        <label>–§—Ä–∞–∑—ã –≤ —à–∞—Ä–∏–∫–∞—Ö (–ø–æ –æ–¥–Ω–æ–π –Ω–∞ —Å—Ç—Ä–æ–∫—É):</label>
        <textarea id="balloons" rows="5">–¢–´ –õ–£–ß–®–ò–ô!
–ñ–ï–õ–ê–Æ –ü–û–ë–ï–î!
LEVEL UP!
–ö–†–£–¢–û–ô –ò–ì–†–û–ö</textarea>
    </div>

    <div class="group check-group">
        <input type="checkbox" id="ttsEnabled" checked>
        <label for="ttsEnabled" style="margin:0; cursor:pointer;">–í–∫–ª—é—á–∏—Ç—å –æ–∑–≤—É—á–∫—É —Å–æ–æ–±—â–µ–Ω–∏–π</label>
    </div>

    <div class="group" id="voiceSettings">
        <label>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≥–æ–ª–æ—Å–∞ –∏ —ç–º–æ—Ü–∏–π:</label>
        
        <select id="voiceSelect" onchange="testVoice(true)"><option>–ó–∞–≥—Ä—É–∑–∫–∞ –≥–æ–ª–æ—Å–æ–≤...</option></select>
        
        <p style="color:#aaa; font-size:18px; margin: 10px 0 5px;">–í—ã–±–µ—Ä–∏—Ç–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ:</p>
        <div class="emotion-grid">
            <button class="emo-btn active" onclick="setEmotion('normal', this)">üòê –û–±—ã—á–Ω–æ–µ</button>
            <button class="emo-btn" onclick="setEmotion('joy', this)">üòÑ –†–∞–¥–æ—Å—Ç—å</button>
            <button class="emo-btn" onclick="setEmotion('fun', this)">ü§™ –ò–≥—Ä–∏–≤–æ—Å—Ç—å</button>
            <button class="emo-btn" onclick="setEmotion('epic', this)">üòé –≠–ø–∏—á–Ω–æ—Å—Ç—å</button>
            <button class="emo-btn" onclick="setEmotion('chipmunk', this)">üêøÔ∏è –ú—É–ª—å—Ç–∏–∫</button>
            <button class="emo-btn" onclick="setEmotion('robo', this)">ü§ñ –†–æ–±–æ—Ç</button>
        </div>

        <div style="display: flex; gap: 15px; margin-top: 10px;">
            <div style="flex:1">
                <label style="font-size:20px">–°–∫–æ—Ä–æ—Å—Ç—å: <span id="rateVal">1.0</span></label>
                <input type="range" id="rate" min="0.5" max="2" step="0.1" value="1" oninput="updateLabels()">
            </div>
            <div style="flex:1">
                <label style="font-size:20px">–¢–æ–Ω (Pitch): <span id="pitchVal">1.0</span></label>
                <input type="range" id="pitch" min="0.1" max="2" step="0.1" value="1" oninput="updateLabels()">
            </div>
        </div>
        <button onclick="testVoice()" style="margin-top:15px; background:#333; color:white; border:1px solid #777; padding:8px; cursor:pointer; width:100%;">üîä –ü—Ä–æ—Å–ª—É—à–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç</button>
    </div>

    <button id="saveBtn" class="btn" onclick="saveAndPublish()">–°–û–•–†–ê–ù–ò–¢–¨ –ò –°–û–ó–î–ê–¢–¨ –°–°–´–õ–ö–£</button>
    <div id="statusMsg"></div>

    <div id="output">
        <p>–°—Å—ã–ª–∫–∞ –≥–æ—Ç–æ–≤–∞! (–û–±–Ω–æ–≤–∏—Ç—Å—è —á–µ—Ä–µ–∑ 1-2 –º–∏–Ω—É—Ç—ã):</p>
        <textarea id="codeResult" rows="6" readonly style="font-size: 14px; color: #0f0; background: #000;"></textarea>
    </div>
</div>

<script>
    let voices = [];
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ –≥–æ–ª–æ—Å–æ–≤ –±—Ä–∞—É–∑–µ—Ä–∞
    function loadVoices() {
        voices = window.speechSynthesis.getVoices();
        const select = document.getElementById('voiceSelect');
        select.innerHTML = '';
        
        // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞: —Å–Ω–∞—á–∞–ª–∞ Google/Microsoft (–æ–Ω–∏ –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–µ–µ), –ø–æ—Ç–æ–º –†—É—Å—Å–∫–∏–µ
        voices.sort((a,b) => {
            const scoreA = (a.name.includes('Google') || a.name.includes('Microsoft')) ? 2 : (a.lang.includes('ru') ? 1 : 0);
            const scoreB = (b.name.includes('Google') || b.name.includes('Microsoft')) ? 2 : (b.lang.includes('ru') ? 1 : 0);
            return scoreB - scoreA;
        });

        voices.forEach(v => {
            const opt = document.createElement('option');
            opt.value = v.voiceURI;
            opt.text = `${v.name} (${v.lang})`;
            select.appendChild(opt);
        });
    }
    window.speechSynthesis.onvoiceschanged = loadVoices;
    setTimeout(loadVoices, 500);

    // –ü—Ä–µ—Å–µ—Ç—ã —ç–º–æ—Ü–∏–π
    function setEmotion(type, btn) {
        document.querySelectorAll('.emo-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');

        const pitch = document.getElementById('pitch');
        const rate = document.getElementById('rate');

        switch(type) {
            case 'normal': pitch.value = 1.0; rate.value = 1.0; break;
            case 'joy': pitch.value = 1.2; rate.value = 1.1; break; // –ß—É—Ç—å –≤—ã—à–µ –∏ –±—ã—Å—Ç—Ä–µ–µ = —Ä–∞–¥–æ—Å—Ç—å
            case 'fun': pitch.value = 1.4; rate.value = 1.3; break; // –í—ã—Å–æ–∫–æ –∏ –±—ã—Å—Ç—Ä–æ = –≤–µ—Å–µ–ª—å–µ
            case 'epic': pitch.value = 0.7; rate.value = 0.8; break; // –ù–∏–∑–∫–æ –∏ –º–µ–¥–ª–µ–Ω–Ω–æ = –ø–∞—Ñ–æ—Å
            case 'chipmunk': pitch.value = 1.8; rate.value = 1.4; break;
            case 'robo': pitch.value = 0.5; rate.value = 1.2; break;
        }
        updateLabels();
        testVoice();
    }

    function updateLabels() {
        document.getElementById('pitchVal').innerText = document.getElementById('pitch').value;
        document.getElementById('rateVal').innerText = document.getElementById('rate').value;
    }

    function testVoice(silent = false) {
        if (!document.getElementById('ttsEnabled').checked) return;
        if(silent) return; // –ü—Ä–æ—Å—Ç–æ –æ–±–Ω–æ–≤–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

        const phrases = ["–° –¥–Ω–µ–º —Ä–æ–∂–¥–µ–Ω–∏—è!", "–¢—ã —Å—É–ø–µ—Ä –∫—Ä—É—Ç–æ–π!", "–ü–æ–∑–¥—Ä–∞–≤–ª—è—é!", "–£—Ä–∞ —É—Ä–∞ —É—Ä–∞!"];
        const text = phrases[Math.floor(Math.random()*phrases.length)];
        
        window.speechSynthesis.cancel();
        const msg = new SpeechSynthesisUtterance(text);
        
        const voiceURI = document.getElementById('voiceSelect').value;
        msg.voice = voices.find(v => v.voiceURI === voiceURI);
        
        msg.pitch = document.getElementById('pitch').value;
        msg.rate = document.getElementById('rate').value;
        
        window.speechSynthesis.speak(msg);
    }

    // --- –ü–£–ë–õ–ò–ö–ê–¶–ò–Ø –ù–ê –°–ï–†–í–ï–† ---
    async function saveAndPublish() {
        const btn = document.getElementById('saveBtn');
        const status = document.getElementById('statusMsg');
        
        btn.disabled = true;
        status.innerText = "–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –º–∏—Ä–∞...";

        const gameId = 'hp-' + Date.now().toString(36); // –ö–æ—Ä–æ—Ç–∫–∏–π ID
        const gameConfig = {
            skyText: document.getElementById('skyMsg').value,
            balloons: document.getElementById('balloons').value.split('\n').filter(line => line.trim() !== ''),
            tts: {
                enabled: document.getElementById('ttsEnabled').checked,
                voiceURI: document.getElementById('voiceSelect').value,
                pitch: parseFloat(document.getElementById('pitch').value),
                rate: parseFloat(document.getElementById('rate').value)
            }
        };

        try {
            // POST –∑–∞–ø—Ä–æ—Å –Ω–∞ Render —Å–µ—Ä–≤–µ—Ä
            const response = await fetch('https://publisher-server-ihqm.onrender.com/publish', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Publish-Key': 'super-secret-123'
                },
                body: JSON.stringify({
                    id: gameId,
                    folder: 'data',
                    data: gameConfig
                })
            });

            if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ' + response.status);

            status.innerText = "–£—Å–ø–µ—à–Ω–æ! –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ GitHub (–∂–¥–∏—Ç–µ ~1 –º–∏–Ω)...";
            
            // –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Å—ã–ª–∫—É
            const gameUrl = `https://kgbgamelab.github.io/67/hp/hp.html?id=${gameId}`;
            const iframeCode = `<iframe src="${gameUrl}" width="800" height="600" style="border:none; border-radius:10px; box-shadow:0 0 20px rgba(0,0,0,0.5);" allow="autoplay"></iframe>`;
            
            document.getElementById('output').style.display = 'block';
            document.getElementById('codeResult').value = iframeCode;

        } catch (error) {
            console.error(error);
            status.innerText = "–û—à–∏–±–∫–∞: " + error.message;
        } finally {
            btn.disabled = false;
        }
    }
</script>

</body>
</html>
